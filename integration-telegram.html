<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="integration-telegram">
  <template>
    <h3>[[alert]]</h3>
    <template is="dom-repeat" items="[[messages]]" as="message">
      <!--<br>[[message.message.text]]
      [[message.message.chat.id]]</br>-->
    </template>
    <paper-button raised class="indigo" on-click="sincronizar">Sincronizar con Telegram</paper-button>
    <iron-ajax
      id="getUpdatesTelegram"
      url="https://api.telegram.org/bot457311764:AAETmA4i-U3r8KMm5EeRni3fq8uGYaqKakQ/getUpdates"
      params='{}'
      handle-as="json"
      on-response="handleResponseGetUpdates"
      on-error="handleUserErrorGetUpdates"
      debounce-duration="300"></iron-ajax>
      <iron-ajax
      id="sendMessage"
      url="https://api.telegram.org/bot457311764:AAETmA4i-U3r8KMm5EeRni3fq8uGYaqKakQ/sendMessage?chat_id=[[idTelegram]]&text=[[MessageBot]]"
      params='{}'
      handle-as="json"
      on-response="handleResponseSendMessageBot"
      on-error="handleUserErrorSendMessageBot"
      debounce-duration="300"></iron-ajax>
  </template>

  <script>
    /**
     * `integration-telegram`
     * Polymer component to consume the Telegram API into aplicationweb-mobile-specialist and realice the follow tasks: Pas to realice the follow taskfrom Telegram, assitance notifications, customized alerts in time to pass list.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class IntegrationTelegram extends Polymer.Element {
      static get is() { return 'integration-telegram'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'integration-telegram'
          },
          messages: {
            type: Array,
            value: []
          },
          tokens: {
            type: Array,
            value: []
          },
          alert: {
            type: String,
            value: ''
          },
          idTelegram: {
            type: Number,
            value: 0
          },
          MessageBot: {
            type: String,
            value: ''
          },
          arrayTesting: {
            type: Array,
            value: [{"idGit":"0","idTelegram":"429645463"},{"idGit":"1","idTelegram":"181857068"},{"idGit":"2","idTelegram":"181857069"}]
          }
        };
      }

      handleResponseSendMessageBot(event){
        console.log(`Status OK: ${event}`);
      }

      handleUserErrorSendMessageBot(event){
        console.log(`Status FAIL: ${event}`);
      }

      setDB(telegramID, gitHubId, code) {
        console.log(`Telegram id = ${telegramID} , gitHub id = ${gitHubId}`);
        this.idTelegram = telegramID;
        this.MessageBot = "Synchronization correct";
        this.$.sendMessage.generateRequest();
        this.tokens = this.tokens.filter(token => token.number != code);
      }

      handleResponseGetUpdates(event) {
        this.messages = event.detail.__data.response.result;
        let position, code;
        for (let message of this.messages){
          position = message.message.text.indexOf(":")
          if (position !== -1){
            code = message.message.text.substr(position + 1);
            for (let token of this.tokens){
              if (token.number == code){
                this.setDB(message.message.chat.id, token.id, code);
              }
            }
          }
        }
      }

      handleUserErrorGetUpdates(event) {
        console.log("Fail" + event);
      }

      generateRandom() {
        return Math.floor((Math.random() * 9999999999) + 1);
      }
      
      obtainIdGit(){
        return Math.floor((Math.random() * 99999) + 1);
      }

      sincronizar(){
        this.$.getUpdatesTelegram.generateRequest();
        const number = this.generateRandom();
        const id = this.obtainIdGit();
        const token = {id, number};
        this.alert = `Ingresa este nÃºmero a telegram: ${token.number}`;
        this.tokens.push(token); 
      }
      
      sendAlert(){
        this.MessageBot = "Don't remember pass list, Please man";
        for (let user of this.arrayTesting){
          this.idTelegram = user.idTelegram;
          this.$.sendMessage.generateRequest();
        }
      }

      connectedCallback() {
        super.connectedCallback();
        
        setInterval(() => { 
          let hour = new Date();
          if ("15:00:00" == hour.toLocaleTimeString()){
            this.sendAlert();
          }
        }, 1000);
      }
    };
    window.customElements.define(IntegrationTelegram.is, IntegrationTelegram);
  </script>
</dom-module>
